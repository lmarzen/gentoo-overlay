name: regen-manifest

on:
  workflow_dispatch: # manual trigger
  push:
    branches: [main]

jobs:
  changes:
    runs-on: ubuntu-latest
    steps:
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            gnome-extra-nemo-audio-tab:
              - 'gnome-extra/nemo-audio-tab/**'
            gnome-extra-nemo-compare:
              - 'gnome-extra/nemo-compare/**'
            gnome-extra-nemo-emblems:
              - 'gnome-extra/nemo-emblems/**'
            gnome-extra-nemo-image-converter:
              - 'gnome-extra/nemo-image-converter/**'
            gnome-extra-nemo-media-columns:
              - 'gnome-extra/nemo-media-columns/**'
            gnome-extra-nemo-python:
              - 'gnome-extra/nemo-python/**'
            gnome-extra-nemo-repairer:
              - 'gnome-extra/nemo-repairer/**'
            sci-ml-ollama:
              - 'sci-ml/ollama/**'

  regen-manifest:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    needs: changes
    outputs:
      manifest-updated: ${{ steps.signal-pkgcheck.outputs.manifest-updated }}
    steps:
      - name: Checkout overlay repo
        uses: actions/checkout@v5

      - name: Set up git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Regenerate manifest for gnome-extra/nemo-audio-tab
        if: steps.changes.outputs.gnome-extra-nemo-audio-tab == 'true'
        env:
          ECN: gnome-extra
          EPN: nemo-audio-tab
        run: scripts/regen-manifest.sh

      - name: Regenerate manifest for gnome-extra/nemo-compare
        if: steps.changes.outputs.gnome-extra-nemo-compare == 'true'
        env:
          ECN: gnome-extra
          EPN: nemo-compare
        run: scripts/regen-manifest.sh

      - name: Regenerate manifest for gnome-extra/nemo-emblems
        if: steps.changes.outputs.gnome-extra-nemo-emblems == 'true'
        env:
          ECN: gnome-extra
          EPN: nemo-emblems
        run: scripts/regen-manifest.sh

      - name: Regenerate manifest for gnome-extra/nemo-image-converter
        if: steps.changes.outputs.gnome-extra-nemo-image-converter == 'true'
        env:
          ECN: gnome-extra
          EPN: nemo-image-converter
        run: scripts/regen-manifest.sh

      - name: Regenerate manifest for gnome-extra/nemo-media-columns
        if: steps.changes.outputs.gnome-extra-nemo-media-columns == 'true'
        env:
          ECN: gnome-extra
          EPN: nemo-media-columns
        run: scripts/regen-manifest.sh

      - name: Regenerate manifest for gnome-extra/nemo-python
        if: steps.changes.outputs.gnome-extra-nemo-python == 'true'
        env:
          ECN: gnome-extra
          EPN: nemo-python
        run: scripts/regen-manifest.sh

      - name: Regenerate manifest for gnome-extra/nemo-repairer
        if: steps.changes.outputs.gnome-extra-nemo-repairer == 'true'
        env:
          ECN: gnome-extra
          EPN: nemo-repairer
        run: scripts/regen-manifest.sh

      - name: Regenerate manifest for sci-ml/ollama
        if: steps.changes.outputs.sci-ml-ollama == 'true'
        env:
          ECN: sci-ml
          EPN: ollama
        run: scripts/regen-manifest.sh

      - name: Push changes
        if: env.MANIFEST_UPDATED == 'true'
        run: |
          git pull --rebase origin main
          git push

      - name: Signal pkgcheck
        id: signal-pkgcheck
        if: env.MANIFEST_UPDATED == 'true'
        run: echo "manifest-updated=true" >> $GITHUB_OUTPUT

  pkgcheck:
    runs-on: ubuntu-latest
    needs: regen-manifest
    if: needs.regen-manifest.outputs.manifest-updated == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Pull latest changes
        run: git pull

      - name: Run pkgcheck
        uses: pkgcore/pkgcheck-action@v1
